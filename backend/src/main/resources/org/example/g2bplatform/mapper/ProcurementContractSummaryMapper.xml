<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.g2bplatform.mapper.ProcurementContractSummaryMapper">

    <!-- ========================================================= -->
    <!-- 수요기관별 물품 조달시장 분석(대시보드) -->
    <!-- - 동적 컬럼 치환 금지: FINAL/FIRST 각각 select 분리 -->
    <!-- - procurement_contract_summary는 "집계 테이블 기반 대표 계약 단위" -->
    <!-- ========================================================= -->

    <select id="selectDemandAgencyTopSalesByFinalDate" resultType="map">
        SELECT
            demand_agency_name AS demandAgencyName,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE demand_agency_name IS NOT NULL
          AND demand_agency_name &lt;&gt; ''
          AND final_contract_date &gt;= #{from}
          AND final_contract_date &lt;= #{to}
        GROUP BY demand_agency_name
        ORDER BY salesAmount DESC
        LIMIT #{topN}
    </select>

    <select id="selectDemandAgencyTopSalesByFirstDate" resultType="map">
        SELECT
            demand_agency_name AS demandAgencyName,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE demand_agency_name IS NOT NULL
          AND demand_agency_name &lt;&gt; ''
          AND first_contract_date &gt;= #{from}
          AND first_contract_date &lt;= #{to}
        GROUP BY demand_agency_name
        ORDER BY salesAmount DESC
        LIMIT #{topN}
    </select>

    <select id="selectDemandAgencyTopContractCountByFinalDate" resultType="map">
        SELECT
            demand_agency_name AS demandAgencyName,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE demand_agency_name IS NOT NULL
          AND demand_agency_name &lt;&gt; ''
          AND final_contract_date &gt;= #{from}
          AND final_contract_date &lt;= #{to}
        GROUP BY demand_agency_name
        ORDER BY contractCount DESC, salesAmount DESC
        LIMIT #{topN}
    </select>

    <select id="selectDemandAgencyTopContractCountByFirstDate" resultType="map">
        SELECT
            demand_agency_name AS demandAgencyName,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE demand_agency_name IS NOT NULL
          AND demand_agency_name &lt;&gt; ''
          AND first_contract_date &gt;= #{from}
          AND first_contract_date &lt;= #{to}
        GROUP BY demand_agency_name
        ORDER BY contractCount DESC, salesAmount DESC
        LIMIT #{topN}
    </select>

    <select id="selectDemandAgencyTopAvgAmountByFinalDate" resultType="map">
        SELECT
            demand_agency_name AS demandAgencyName,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE demand_agency_name IS NOT NULL
          AND demand_agency_name &lt;&gt; ''
          AND final_contract_date &gt;= #{from}
          AND final_contract_date &lt;= #{to}
        GROUP BY demand_agency_name
        ORDER BY avgAmount DESC, salesAmount DESC
        LIMIT #{topN}
    </select>

    <select id="selectDemandAgencyTopAvgAmountByFirstDate" resultType="map">
        SELECT
            demand_agency_name AS demandAgencyName,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE demand_agency_name IS NOT NULL
          AND demand_agency_name &lt;&gt; ''
          AND first_contract_date &gt;= #{from}
          AND first_contract_date &lt;= #{to}
        GROUP BY demand_agency_name
        ORDER BY avgAmount DESC, salesAmount DESC
        LIMIT #{topN}
    </select>

    <select id="selectReportGoodsList" resultType="map">
        SELECT
            bid_notice_no        AS bidNoticeNo,
            vendor_name          AS vendorName,
            vendor_biz_reg_no    AS vendorBizRegNo,
            contract_title      AS contractTitle,
            demand_agency_name  AS demandAgencyName,
            demand_agency_region AS demandAgencyRegion,
            detail_item_name     AS detailItemName,
            contract_method      AS contractMethod,
            DATE_FORMAT(first_contract_date, '%Y-%m-%d')  AS firstContractDate,
            first_contract_amount AS firstContractAmount,
            DATE_FORMAT(final_contract_date, '%Y-%m-%d')  AS finalContractDate,
            final_contract_amount AS finalContractAmount,
            contract_count      AS contractCount,
            is_long_term        AS isLongTerm,
            IFNULL(saved, 'N')   AS saved
        FROM procurement_contract_summary
        WHERE 1=1
        <if test="demandAgencyName != null and demandAgencyName != ''">
            AND demand_agency_name LIKE CONCAT('%', #{demandAgencyName}, '%')
        </if>
        <if test="demandAgencyRegion != null and demandAgencyRegion != ''">
            AND demand_agency_region LIKE CONCAT('%', #{demandAgencyRegion}, '%')
        </if>
        <if test="detailItemName != null and detailItemName != ''">
            AND detail_item_name LIKE CONCAT('%', #{detailItemName}, '%')
        </if>
        <if test="contractMethod != null and contractMethod != ''">
            AND contract_method LIKE CONCAT('%', #{contractMethod}, '%')
        </if>
        <if test="firstContractDate != null and firstContractDate != ''">
            AND first_contract_date = #{firstContractDate}
        </if>
        <if test="year != null">
            AND first_contract_date &gt;= CONCAT(#{year}, '-01-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{year}, '-01-01'), INTERVAL 1 YEAR)
        </if>
        <if test="month != null and month != ''">
            AND first_contract_date &gt;= CONCAT(#{month}, '-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{month}, '-01'), INTERVAL 1 MONTH)
        </if>
        <if test="rangeStart != null and rangeStart != '' and rangeEnd != null and rangeEnd != ''">
            AND first_contract_date &gt;= CONCAT(#{rangeStart}, '-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{rangeEnd}, '-01'), INTERVAL 1 MONTH)
        </if>
        <if test="showSavedOnly == true">
            AND saved = 'Y'
        </if>
        ORDER BY first_contract_date DESC, bid_notice_no, vendor_biz_reg_no
        LIMIT #{start}, #{length}
    </select>

    <!-- 엑셀용 Keyset 페이지네이션: LIMIT offset 대비 대용량 시에도 O(1) 유지 -->
    <select id="selectReportGoodsListKeyset" resultType="map">
        SELECT
            bid_notice_no        AS bidNoticeNo,
            vendor_name          AS vendorName,
            vendor_biz_reg_no    AS vendorBizRegNo,
            contract_title       AS contractTitle,
            demand_agency_name   AS demandAgencyName,
            demand_agency_region AS demandAgencyRegion,
            detail_item_name     AS detailItemName,
            contract_method      AS contractMethod,
            DATE_FORMAT(first_contract_date, '%Y-%m-%d')  AS firstContractDate,
            first_contract_amount AS firstContractAmount,
            DATE_FORMAT(final_contract_date, '%Y-%m-%d')  AS finalContractDate,
            final_contract_amount AS finalContractAmount,
            contract_count       AS contractCount,
            is_long_term         AS isLongTerm,
            IFNULL(saved, 'N')    AS saved
        FROM procurement_contract_summary
        WHERE 1=1
        <if test="lastFirstContractDate != null and lastBidNoticeNo != null and lastVendorBizRegNo != null">
            AND (first_contract_date, bid_notice_no, vendor_biz_reg_no) &lt; (#{lastFirstContractDate}, #{lastBidNoticeNo}, #{lastVendorBizRegNo})
        </if>
        <if test="demandAgencyName != null and demandAgencyName != ''">
            AND demand_agency_name LIKE CONCAT('%', #{demandAgencyName}, '%')
        </if>
        <if test="demandAgencyRegion != null and demandAgencyRegion != ''">
            AND demand_agency_region LIKE CONCAT('%', #{demandAgencyRegion}, '%')
        </if>
        <if test="detailItemName != null and detailItemName != ''">
            AND detail_item_name LIKE CONCAT('%', #{detailItemName}, '%')
        </if>
        <if test="contractMethod != null and contractMethod != ''">
            AND contract_method LIKE CONCAT('%', #{contractMethod}, '%')
        </if>
        <if test="firstContractDate != null and firstContractDate != ''">
            AND first_contract_date = #{firstContractDate}
        </if>
        <if test="year != null">
            AND first_contract_date &gt;= CONCAT(#{year}, '-01-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{year}, '-01-01'), INTERVAL 1 YEAR)
        </if>
        <if test="month != null and month != ''">
            AND first_contract_date &gt;= CONCAT(#{month}, '-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{month}, '-01'), INTERVAL 1 MONTH)
        </if>
        <if test="rangeStart != null and rangeStart != '' and rangeEnd != null and rangeEnd != ''">
            AND first_contract_date &gt;= CONCAT(#{rangeStart}, '-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{rangeEnd}, '-01'), INTERVAL 1 MONTH)
        </if>
        <if test="showSavedOnly == true">
            AND saved = 'Y'
        </if>
        ORDER BY first_contract_date DESC, bid_notice_no, vendor_biz_reg_no
        LIMIT #{length}
    </select>

    <select id="selectReportGoodsCount" resultType="int">
        SELECT COUNT(*)
        FROM procurement_contract_summary
        WHERE 1=1
        <if test="demandAgencyName != null and demandAgencyName != ''">
            AND demand_agency_name LIKE CONCAT('%', #{demandAgencyName}, '%')
        </if>
        <if test="demandAgencyRegion != null and demandAgencyRegion != ''">
            AND demand_agency_region LIKE CONCAT('%', #{demandAgencyRegion}, '%')
        </if>
        <if test="detailItemName != null and detailItemName != ''">
            AND detail_item_name LIKE CONCAT('%', #{detailItemName}, '%')
        </if>
        <if test="contractMethod != null and contractMethod != ''">
            AND contract_method LIKE CONCAT('%', #{contractMethod}, '%')
        </if>
        <if test="firstContractDate != null and firstContractDate != ''">
            AND first_contract_date = #{firstContractDate}
        </if>
        <if test="year != null">
            AND first_contract_date &gt;= CONCAT(#{year}, '-01-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{year}, '-01-01'), INTERVAL 1 YEAR)
        </if>
        <if test="month != null and month != ''">
            AND first_contract_date &gt;= CONCAT(#{month}, '-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{month}, '-01'), INTERVAL 1 MONTH)
        </if>
        <if test="rangeStart != null and rangeStart != '' and rangeEnd != null and rangeEnd != ''">
            AND first_contract_date &gt;= CONCAT(#{rangeStart}, '-01')
            AND first_contract_date &lt; DATE_ADD(CONCAT(#{rangeEnd}, '-01'), INTERVAL 1 MONTH)
        </if>
        <if test="showSavedOnly == true">
            AND saved = 'Y'
        </if>
    </select>

    <update id="updateSaved">
        UPDATE procurement_contract_summary
        SET saved = #{saved}
        WHERE bid_notice_no = #{bidNoticeNo}
          AND vendor_biz_reg_no = #{vendorBizRegNo}
    </update>

    <!-- ========================================================= -->
    <!-- 지역별 물품 조달시장 분석(대시보드) -->
    <!-- - first_contract_date로 기간 필터, final_contract_amount 집계 -->
    <!-- - demand_agency_region 기준 그룹 (시/도 단위: 구 제외, 공백 앞 부분만) -->
    <!-- ========================================================= -->
    <select id="selectRegionMarketByFirstDate" resultType="map">
        SELECT
            SUBSTRING_INDEX(COALESCE(NULLIF(TRIM(demand_agency_region), ''), '(미지정)'), ' ', 1) AS region,
            IFNULL(SUM(final_contract_amount), 0) AS salesAmount,
            COUNT(*) AS contractCount,
            IFNULL(SUM(final_contract_amount), 0) / COUNT(*) AS avgAmount
        FROM procurement_contract_summary
        WHERE first_contract_date &gt;= #{from}
          AND first_contract_date &lt;= #{to}
        GROUP BY SUBSTRING_INDEX(COALESCE(NULLIF(TRIM(demand_agency_region), ''), '(미지정)'), ' ', 1)
        ORDER BY salesAmount DESC
    </select>
</mapper>
